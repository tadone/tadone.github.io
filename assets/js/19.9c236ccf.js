(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{183:function(e,t,a){"use strict";a.r(t);var s=a(0),n=Object(s.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"content"},[a("h1",{attrs:{id:"my-clusters"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#my-clusters","aria-hidden":"true"}},[e._v("#")]),e._v(" My Clusters")]),e._v(" "),a("h2",{attrs:{id:"gce-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gce-cluster","aria-hidden":"true"}},[e._v("#")]),e._v(" GCE Cluster")]),e._v(" "),a("p",[e._v("Built using: console.cloud.google.com\nThe cluster consist of 3 nodes (VMs) that are built using "),a("strong",[e._v("gke-tad1-cluster-pool-micro")]),e._v(" template. Originally the cluster was set up with")]),e._v(" "),a("p",[e._v("Cluster options:")]),e._v(" "),a("ul",[a("li",[e._v("Choose Zonal: us-west1-a")]),e._v(" "),a("li",[e._v("Pick your kubernetes version: 1.10.7-gke.2")]),e._v(" "),a("li",[e._v("Create a 3-node pool using the cheapest instance type - f1-micro (1 vCPU, 0.6 GB memory)")]),e._v(" "),a("li",[e._v("Boot disk size to 10GB, (don't enable preemptible nodes. They're cheaper but IP changes every day)")]),e._v(" "),a("li",[e._v("Enable auto-upgrade and auto-repair.")])]),e._v(" "),a("p",[e._v("Below the node pool there are some additional options.")]),e._v(" "),a("ul",[a("li",[e._v("Disable HTTP load balancing (load balancing is expensive in GCP) and also")]),e._v(" "),a("li",[e._v("Disable all the StackDriver stuff (also can be expensive and has flaky reliability in my experience) as well as - Disable the kubernetes dashboard")])]),e._v(" "),a("h3",{attrs:{id:"gcloud-cli"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gcloud-cli","aria-hidden":"true"}},[e._v("#")]),e._v(" GCloud CLI")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("brew cask "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" google-cloud-sdk\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# GCloud")]),e._v("\ngcloud auth login\ngcloud config "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("set")]),e._v(" project kubernetes-tad1\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Obtain Kubernetes config file")]),e._v("\ngcloud container clusters get-credentials tad1-cluster --zone"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("us-west1-a\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Create cluster role-binding")]),e._v("\nkubectl create clusterrolebinding cluster-admin-binding --clusterrole cluster-admin --user "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("gcloud config get-value account"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Same as above but with speciic user")]),e._v("\nkubectl create clusterrolebinding myname-cluster-admin-binding \\\n  --clusterrole"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cluster-admin \\\n  --user"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("tadone@gmail.com\n")])])]),a("h3",{attrs:{id:"traefik-load-balancer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#traefik-load-balancer","aria-hidden":"true"}},[e._v("#")]),e._v(" Traefik Load Balancer")]),e._v(" "),a("p",[e._v("To test out traefik.toml without valid certificate:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("defaultEntryPoints "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"http"')]),e._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"https"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("entryPoints"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("entryPoints.http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n  address "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('":80"')]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("entryPoints.http.forwardedHeaders"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n      trustedIPs "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"0.0.0.0/0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("entryPoints.http.redirect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n      entryPoint "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"https"')]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("entryPoints.https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n  address "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('":443"')]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("entryPoints.https.tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("entryPoints.https.forwardedHeaders"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n      trustedIPs "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"0.0.0.0/0"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n")])])]),a("div",{staticClass:"warning custom-block"},[a("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),a("p",[e._v("Install minikube: "),a("code",[e._v("brew cask install minikube")])])]),e._v(" "),a("h2",{attrs:{id:"minkube-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#minkube-cluster","aria-hidden":"true"}},[e._v("#")]),e._v(" Minkube Cluster")]),e._v(" "),a("p",[e._v("Minkube is used to test Kubernetes locally")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Download hyperkit driver")]),e._v("\nbrew "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" hyperkit\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("chown")]),e._v(" root:wheel "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("brew --prefix"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("/opt/docker-machine-driver-hyperkit/bin/docker-machine-driver-hyperkit\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("chmod")]),e._v(" u+s "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("brew --prefix"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("/opt/docker-machine-driver-hyperkit/bin/docker-machine-driver-hyperkit\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Start minikube")]),e._v("\nminikube start --vm-driver hyperkit\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Deploy hello-minikube image")]),e._v("\nkubectl run hello-minikube --image"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("k8s.gcr.io/echoserver:1.10 --port"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("8080\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Create a Service object that exposes the deployment:")]),e._v("\nkubectl expose deployment hello-minikube --type"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("NodePort\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# When the pod is running we can curl it")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("minikube "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("service")]),e._v(" hello-minikube --url"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Clean up")]),e._v("\nkubectl delete services hello-minikube\nkubectl delete deployment hello-minikube\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Optionally stop minikube")]),e._v("\nminikube stop\n")])])]),a("h3",{attrs:{id:"create-service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-service","aria-hidden":"true"}},[e._v("#")]),e._v(" Create Service")]),e._v(" "),a("div",{staticClass:"warning custom-block"},[a("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),a("p",[e._v("Use a cloud provider like Google Kubernetes Engine or Amazon Web Services to create a Kubernetes cluster. This tutorial creates an external load balancer, which requires a cloud provider.")]),e._v(" "),a("p",[e._v("Configure kubectl to communicate with your Kubernetes API server. For instructions, see the documentation for your cloud provider.")])]),e._v(" "),a("p",[e._v("Creating a service for an application running in five pods.")]),e._v(" "),a("ol",[a("li",[e._v("This command creates a Deployment object and an associated ReplicaSet object. The ReplicaSet has five Pods, each of which runs the Hello World application.")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl run hello-world --replicas"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("5 --labels"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"run=load-balancer-example"')]),e._v(" --image"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("gcr.io/google-samples/node-hello:1.0  --port"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("8080\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[e._v("Display information about the Deployment and ReplicaSets")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Deployment")]),e._v("\nkubectl get deployments hello-world\nkubectl describe deployments hello-world\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# ReplicaSets")]),e._v("\nkubectl get replicasets\nkubectl describe replicasets\n")])])]),a("ol",{attrs:{start:"3"}},[a("li",[e._v("Create a Service object that exposes the deployment:")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl expose deployment hello-world --type"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("LoadBalancer --name"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("my-service\n")])])]),a("ol",{attrs:{start:"4"}},[a("li",[e._v("Display information about the Service:")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl get services my-service\nkubectl describe services my-service\n")])])]),a("p",[e._v("Make a note of the external IP address ("),a("code",[e._v("LoadBalancer Ingress")]),e._v(") exposed by your service. Also note the value of "),a("code",[e._v("Port")]),e._v(" and "),a("code",[e._v("NodePort")]),e._v(".")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("Port")]),e._v(" - internal to kubernetes")]),e._v(" "),a("li",[a("code",[e._v("NodePoert")]),e._v(" - external to the world")])]),e._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[e._v("In the "),a("code",[e._v("describe services my-service")]),e._v(" output, you can see that the service has several endpoints.  These are internal addresses of the pods that are running the Hello World application. To verify these are pod addresses, enter this command:")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl get pods --output"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("wide\n")])])]),a("p",[e._v("Use the external IP address (LoadBalancer Ingress) to access the Hello World application:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Minikube (Will automatically open in browser)")]),e._v("\nminikube "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("service")]),e._v(" my-service\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Cloud provider")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" http://"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("external-ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(":"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),a("p",[e._v("Where "),a("code",[e._v("<external-ip>")]),e._v(" is the external IP address ("),a("code",[e._v("LoadBalancer Ingress")]),e._v(") of your Service, and "),a("code",[e._v("<port>")]),e._v(" is the value of "),a("code",[e._v("Port")]),e._v(" in your Service description. The response to a successful request is a hello message: "),a("code",[e._v("Hello Kubernetes!")])]),e._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[e._v("Cleaning Up")])]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("kubectl delete services my-service\nkubectl delete deployment hello-world\n")])])]),a("h3",{attrs:{id:"hostpath"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hostpath","aria-hidden":"true"}},[e._v("#")]),e._v(" HostPath")]),e._v(" "),a("p",[e._v("HostPath (single node testing only – local storage is not supported in any way and "),a("strong",[e._v("WILL NOT WORK")]),e._v(" in a multi-node cluster)")]),e._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" PersistentVolume\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("data\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" gitlab\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("capacity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 8Gi\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" ReadWriteMany\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/tmp/gitlab-data"')]),e._v("\n")])])])])}],!1,null,null,null);n.options.__file="cluster.md";t.default=n.exports}}]);